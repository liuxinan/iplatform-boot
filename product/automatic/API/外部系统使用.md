

# 1 规范说明

## 1.1 通信协议

HTTP协议

## 1.2 请求方法

只支持POST请求

## 1.3 字符编码

统一UTF-8编码格式

# 2 接口定义

## 2.1 预案执行接口

### 2.1.1 接口地址

/autoengine/automaticrunengine/api/v1/engine/scenario/exec

### 2.1.2 参数

#### 2.1.2.1 入参

```json
{
    "notify":"no",  // 默认传no
    "scenarioArgs":{
        "exeUserId":"执行人账号",
        "scenarioId":"预案ID，外部系统生成传入",
        "taskArgs":[
            {
                "id":"关联任务ID，外部系统生成传入",
                "varList":[
                    {
                        "varName":"变量名",
                        "varType":1, // 变量类型，默认为运行时变量
                        "varValue":"变量值"
                    }
                ]
            }
        ], // 运行时变量，没有可以不传
        "triggerType":0 // 默认传0
    },
    "scenarioDetailParam":{
        "id":"关联预案ID，外部系统生成传入",
        "plugin_rels":[
            {
                "id":"关联任务ID，外部系统生成传入",
                "related_scenario_id":"关联预案ID，外部系统生成传入",
                "type":"script"  // 任务类型，均为脚本类型
            }
        ],
        "singleton":0, // 默认传0
        "status":1, // 默认传1
        "task_rels":[
            {
                "from_task_id":"关联源任务ID，外部系统生成传入",
                "if_type":0, //默认传0
                "related_scenario_id":"预案ID，外部系统生成传入",
                "to_task_id":"关联目标任务ID，外部系统生成传入"
            }
        ],
        "tasks":[
            {
                "cmd_detail":"echo 123", // 任务执行脚本内容
                "id":"任务ID,外部系统生成传入",
                "owner_id":"关联预案ID，外部系统生成传入",
                "owner_type":0, // 默认传0
                "plugin_kind":"script",  // 表示脚本shell
                "result_keywords":"", // 默认传空字符
                "result_type":2, // 默认传2
                "source_ids":"数据源ID，外部生成传入", // 数据源ID，多数据源英文逗号分隔（外部系统生成传入）
                "source_list":[
                    {
                        "dataSourceName":"192.168.55.50", //ip
                        "devIp":"192.168.55.50", //ip
                        "displayName":"192.168.55.50", //ip
                        "id":"关联数据源ID，外部系统生成传入",
                        "password":"123123",  // ssh登录密码
                        "port":22,  // ssh登录端口
                        "userName":"root" //ssh登录用户名
                    }
                ],
                "task_name":"任务名称",
                "task_type,":1, // 默认传1
                "task_vars":{
                    "related_task_id":"关联任务ID，外部系统生成传入",
                    "variable_name":"变量名",
                    "variable_type":1,
                    "variable_value":"变量值"
                },
                "timeout":60 // 任务超时时间，单位秒
            }
        ]
    },
    "sync":false,  // 默认传false
    "system":"第三方系统标识" //用于接收MQ返回值
}
```



#### 2.1.2.2 出参

```json
{
    "data":"预案实例ID", // 预案实例ID，用于异步获取预案执行结果
    "message":"文字描述",
    "success":true
}
```

### 2.1.3 异步接收任务运行结果

#### 2.1.3.1 接收方式

统一使用ActiveMQ，并已Queue方式接收消息。

#### 2.1.3.2 订阅方法

```java
@JmsListener(destination = "[第三方系统标识].QUEUE_SCEN_INST_EXEC_NOTIFY", containerFactory = "队列监听工厂")
```

说明：

第三方系统标识：入参system属性值

队列监听工厂：使用Queue方式接收MQ消息

#### 2.1.3.3 消息体

```json
{
    "scenarioInst":{
        "error_info":"错误信息",
        "id":"2c230593817c4300bb8ad4b4bbf0f3ab",
        "status":1 //预案执行状态
    },
    "type":2  // 消息类型
}
```

说明：

type：当type=2时，预案执行完毕，其他类型的消息是执行中间状态，可根据实际需求进行监听处理。

status：预案执行状态，1：成功，0：失败



## 3.1 任务执行接口

### 3.1.1 接口地址

/autoengine/automaticrunengine/api/v1/engine/task/sync/exec

### 3.1.2 参数

#### 3.1.2.1 入参

```json
{
    "bussId":"业务系统标识",
    "exe_user_id":"执行人账号",
    "pluginKind":"script",
    "runnerId":"任务ID，外部系统生成",
    "runnerType":0,
    "scriptType":1,
    "snapshot":"{"cmdDetail":"任务执行脚本内容","pageNo":-1,"pageSize":0,"resultKeywords":"","resultType":2,"scriptType":1,"subTaskSnapshots":[{"dataSourceId":"数据源主键ID，外部系统生成","dataSourceName":"数据源IP"}],"task_name":"任务名称","timeout":60}",
    "source_list":[
        {
            "dataSourceName":"192.168.55.50",
            "devIp":"192.168.55.50",
            "displayName":"192.168.55.50",
            "id":"关联数据源主键ID，外部系统生成传入",
            "password":"123",
            "port":"22",
            "userName":"root"
        }
    ],
    "system":"所属系统标识",
    "taskName":"任务名称",
    "timeout":60
}
```

说明：

snapshot：任务执行实例快照，是一个字符串。

bussId：所属系统中的业务逻辑标识，如远程文件抓取（pullfile）、任务测试（tasktest）等。

#### 3.1.2.2 出参

```json
{
    "data":{
        "errorInfo":"错误描述",
        "runDetail":"任务执行结果",
        "taskInstId":"任务实例ID"
    },
    "message":"文字描述",
    "success":true
}
```

